#!/usr/bin/env bash
set -euo pipefail

# Args: $1 = commit message file
msg_file="${1:-}"

# If no file was provided, bail.
if [[ -z "$msg_file" ]] || [[ ! -f "$msg_file" ]]; then
  exit 0
fi

# If a non-comment, non-blank line already exists, leave it.
if grep -Eq '^[[:space:]]*[^#[:space:]]+' "$msg_file"; then
  exit 0
fi

staged_files="$(git diff --cached --name-only)"

# If no staged files, keep a simple default.
if [[ -z "$staged_files" ]]; then
  default_msg="${BESEO_COMMIT_MSG:-BESEO: update}"
  printf '%s\n' "$default_msg" > "$msg_file"
  exit 0
fi

# Build a short file summary for the commit title.
build_file_summary() {
  local max=3
  local files=()
  while IFS= read -r f; do
    files+=("$f")
  done <<<"$staged_files"

  local total=${#files[@]}
  if (( total == 0 )); then
    return
  fi

  if (( total <= max )); then
    printf '%s' "$(IFS=', '; echo "${files[*]}")"
  else
    local head=("${files[@]:0:max}")
    printf '%s (+%d more)' "$(IFS=', '; echo "${head[*]}")" "$((total - max))"
  fi
}

file_summary="$(build_file_summary)"

# Build a quick summary from touched areas unless BESEO_COMMIT_MSG is set.
if [[ -n "${BESEO_COMMIT_MSG:-}" ]]; then
  summary="${BESEO_COMMIT_MSG}"
else
  summary_parts=()
  add_part() {
    local part="$1"
    for existing in "${summary_parts[@]:-}"; do
      [[ "$existing" == "$part" ]] && return 0
    done
    summary_parts+=("$part")
  }

  while IFS= read -r f; do
    [[ "$f" == includes/admin/page-schema.php* ]] && add_part "schema admin"
    [[ "$f" == includes/admin/page-social-media.php* ]] && add_part "social admin"
    [[ "$f" == includes/engine/* ]] && add_part "engine"
    [[ "$f" == .githooks/* ]] && add_part "tooling"
    [[ "$f" == tests/* ]] && add_part "tests"
    [[ "$f" == beseo-devnotes.json || "$f" == BE_SEO-Dev_Notes.json ]] && add_part "devnotes"
  done <<<"$staged_files"

  if [[ ${#summary_parts[@]} -eq 0 ]]; then
    summary="BESEO: update"
  else
    summary="BESEO: $(IFS=' + '; echo "${summary_parts[*]}")"
  fi
fi

if [[ -n "$file_summary" ]]; then
  summary="${summary} - ${file_summary}"
fi

{
  printf '%s\n' "$summary"
  echo
  echo "Summary:"
  while IFS= read -r f; do
    printf -- "- %s\n" "$f"
  done <<<"$staged_files"
} > "$msg_file"
