#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

# Select Python executable (prefer python3, fallback to python).
if command -v python3 >/dev/null 2>&1; then
  PYTHON=python3
elif command -v python >/dev/null 2>&1; then
  PYTHON=python
else
  echo "BESEO pre-commit: python3 or python not found in PATH" >&2
  exit 1
fi

BUMP="${BESEO_BUMP:-patch}"
if [[ "$BUMP" != "minor" && "$BUMP" != "patch" ]]; then
  echo "BESEO_BUMP must be 'minor' or 'patch' (default: patch)" >&2
  exit 1
fi

VERSION_FILE="beseo.php"
NOTES_FILE="BE_SEO-Dev_Notes.json"
CHANGELOG_FILE="CHANGELOG.md"

if [[ ! -f "$VERSION_FILE" ]]; then
  echo "Version file missing: $VERSION_FILE" >&2
  exit 1
fi

current_version="$($PYTHON - "$VERSION_FILE" <<'PY'
import sys, re
path = sys.argv[1]
text = open(path).read()
m = re.search(r'Version:\s*([0-9]+\.[0-9]+\.[0-9]+)', text)
if not m:
    sys.exit(1)
print(m.group(1))
PY
)" || { echo "Could not read current version" >&2; exit 1; }

IFS=. read -r major minor patch <<<"$current_version"
if [[ "$BUMP" == "minor" ]]; then
  minor=$((minor + 1))
  patch=0
else
  patch=$((patch + 1))
fi
new_version="${major}.${minor}.${patch}"

$PYTHON - "$VERSION_FILE" "$current_version" "$new_version" <<'PY'
import sys, re
path, old, new = sys.argv[1], sys.argv[2], sys.argv[3]
text = open(path).read()
text_new = re.sub(r'(Version:\s*)' + re.escape(old), r'\g<1>' + new, text, count=1)
text_new = re.sub(r"(BE_SCHEMA_ENGINE_VERSION',\s*')" + re.escape(old) + "'", r"\g<1>" + new + "'", text_new, count=1)
if text == text_new:
    sys.exit(1)
open(path, 'w').write(text_new)
PY

$PYTHON - "$NOTES_FILE" "$new_version" <<'PY'
import json, sys
path, new = sys.argv[1], sys.argv[2]
try:
    data = json.loads(open(path).read())
except Exception:
    data = {}
if "meta" not in data:
    data["meta"] = {}
data["meta"]["version"] = new
open(path, 'w').write(json.dumps(data, indent=2))
PY

$PYTHON - "$CHANGELOG_FILE" "$new_version" "$BUMP" <<'PY'
import sys, datetime, os, subprocess

path, version, bump = sys.argv[1], sys.argv[2], sys.argv[3]

def staged_files():
    try:
        out = subprocess.check_output(["git", "diff", "--cached", "--name-only"], text=True)
        return [line for line in out.splitlines() if line.strip()]
    except Exception:
        return []

def categorize(files):
    parts = []
    def add_part(part):
        if part not in parts:
            parts.append(part)
    for f in files:
        if f.startswith("includes/admin/page-schema.php"):
            add_part("schema admin")
        if f.startswith("includes/admin/page-social-media.php"):
            add_part("social admin")
        if f.startswith("includes/engine/"):
            add_part("engine")
        if f.startswith(".githooks/") or f.startswith(".github/"):
            add_part("tooling")
        if f.startswith("tests/"):
            add_part("tests")
        if f in ("beseo-devnotes.json", "BE_SEO-Dev_Notes.json"):
            add_part("devnotes")
    return parts

def build_summary(files, env_msg, parts):
    if env_msg:
        return env_msg
    if not parts:
        return "BESEO: update"
    return "BESEO: " + " + ".join(parts)

def build_description(env_desc, parts, files, summary):
    if env_desc and env_desc.strip():
        return env_desc.strip()
    if parts:
        return "Areas touched: " + ", ".join(parts) + "."
    if files:
        return "Update touching staged files."
    return summary or "BESEO: update"

files = staged_files()
parts = categorize(files)
summary = build_summary(files, os.environ.get("BESEO_COMMIT_MSG"), parts)
description = build_description(os.environ.get("BESEO_CHANGELOG_DESC"), parts, files, summary)

header = "# Changelog"
today = datetime.datetime.now().strftime("%Y-%m-%d")
entry_lines = [
    f"## [{version}] - {today}",
    f"- Bump type: {bump}",
    f"- Summary: {summary}",
    f"- Description: {description}",
    "- Details:",
]
if files:
    entry_lines += [f"- {f}" for f in files]
else:
    entry_lines.append("- (no staged files listed)")
entry = "\n".join(entry_lines) + "\n\n"
if os.path.exists(path):
    existing = open(path).read()
else:
    existing = ""
if existing.startswith(header):
    rest = existing[len(header):].lstrip("\n")
    new_content = header + "\n\n" + entry + rest
else:
    new_content = header + "\n\n" + entry + existing
open(path, 'w').write(new_content)
PY

git add "$VERSION_FILE" "$NOTES_FILE" "$CHANGELOG_FILE"

echo "BESEO pre-commit: bumped version to $new_version ($BUMP) and updated changelog."
