#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

# Select Python executable (prefer python3, fallback to python).
if command -v python3 >/dev/null 2>&1; then
  PYTHON=python3
elif command -v python >/dev/null 2>&1; then
  PYTHON=python
else
  echo "BESEO pre-commit: python3 or python not found in PATH" >&2
  exit 1
fi

BUMP="${BESEO_BUMP:-patch}"
if [[ "$BUMP" != "minor" && "$BUMP" != "patch" ]]; then
  echo "BESEO_BUMP must be 'minor' or 'patch' (default: patch)" >&2
  exit 1
fi

VERSION_FILE="beseo.php"
NOTES_FILE="BE_SEO-Dev_Notes.json"
CHANGELOG_FILE="CHANGELOG.md"

if [[ ! -f "$VERSION_FILE" ]]; then
  echo "Version file missing: $VERSION_FILE" >&2
  exit 1
fi

current_version="$($PYTHON - "$VERSION_FILE" <<'PY'
import sys, re
path = sys.argv[1]
text = open(path).read()
m = re.search(r'Version:\s*([0-9]+\.[0-9]+\.[0-9]+)', text)
if not m:
    sys.exit(1)
print(m.group(1))
PY
)" || { echo "Could not read current version" >&2; exit 1; }

IFS=. read -r major minor patch <<<"$current_version"
if [[ "$BUMP" == "minor" ]]; then
  minor=$((minor + 1))
  patch=0
else
  patch=$((patch + 1))
fi
new_version="${major}.${minor}.${patch}"

$PYTHON - "$VERSION_FILE" "$current_version" "$new_version" <<'PY'
import sys, re
path, old, new = sys.argv[1], sys.argv[2], sys.argv[3]
text = open(path).read()
text_new = re.sub(r'(Version:\s*)' + re.escape(old), r'\g<1>' + new, text, count=1)
text_new = re.sub(r"(BE_SCHEMA_ENGINE_VERSION',\s*')" + re.escape(old) + "'", r"\g<1>" + new + "'", text_new, count=1)
if text == text_new:
    sys.exit(1)
open(path, 'w').write(text_new)
PY

$PYTHON - "$NOTES_FILE" "$new_version" <<'PY'
import json, sys
path, new = sys.argv[1], sys.argv[2]
try:
    data = json.loads(open(path).read())
except Exception:
    data = {}
if "meta" not in data:
    data["meta"] = {}
data["meta"]["version"] = new
open(path, 'w').write(json.dumps(data, indent=2))
PY

$PYTHON - "$CHANGELOG_FILE" "$new_version" "$BUMP" <<'PY'
import sys, datetime, os, subprocess

path, version, bump = sys.argv[1], sys.argv[2], sys.argv[3]

def staged_files():
    try:
        out = subprocess.check_output(["git", "diff", "--cached", "--name-only"], text=True)
        return [line for line in out.splitlines() if line.strip()]
    except Exception:
        return []

def categorize(files):
    parts = []
    def add_part(part):
        if part not in parts:
            parts.append(part)
    for f in files:
        if f.startswith("includes/admin/page-schema.php"):
            add_part("schema admin")
        if f.startswith("includes/admin/page-social-media.php"):
            add_part("social admin")
        if f.startswith("includes/engine/"):
            add_part("engine")
        if f.startswith(".githooks/") or f.startswith(".github/"):
            add_part("tooling")
        if f.startswith("tests/"):
            add_part("tests")
        if f in ("beseo-devnotes.json", "BE_SEO-Dev_Notes.json"):
            add_part("devnotes")
    return parts

def build_summary(parts, env_msg):
    if env_msg:
        return env_msg.strip()
    if not parts:
        return "update"
    return " + ".join(parts)

def normalize_summary_text(text):
    if not text:
        return ""
    clean = text.strip()
    if clean.lower().startswith("beseo:"):
        clean = clean.split(":", 1)[1].strip()
    if clean:
        clean = clean[0].upper() + clean[1:]
    if clean and clean[-1] not in ".!?":
        clean += "."
    return clean

def build_focus_line(summary, parts, env_desc):
    base = env_desc.strip() if env_desc and env_desc.strip() else ""
    if not base:
        base = summary if summary else ("Focus on " + " + ".join(parts) if parts else "Update")
    base = normalize_summary_text(base)
    if not base:
        base = "Update."
    return "Summary: " + base, base

def build_changed_items(parts, files, summary_text):
    if parts:
        return ["Touched areas: " + ", ".join(parts) + "."]
    if files:
        return ["Updated staged files."]
    return [summary_text or "Maintenance."]

def add_section(buf, title, items):
    if not items:
        return
    buf.extend([f"### {title}"] + [f"- {item}" for item in items] + [""])

files = staged_files()
parts = categorize(files)
summary = build_summary(parts, os.environ.get("BESEO_COMMIT_MSG"))
focus_line, summary_text = build_focus_line(summary, parts, os.environ.get("BESEO_CHANGELOG_DESC"))
changed_items = build_changed_items(parts, files, summary_text)

header = "\n".join([
    "# Changelog",
    "",
    "All notable changes to this project will be documented in this file. The format follows clear, human-readable version entries grouped by change type.",
    "",
    "<hr />",
])
today = datetime.datetime.now().strftime("%Y-%m-%d")
entry_lines = [
    f"## [{version}] - {today}",
    focus_line,
    "",
]

add_section(entry_lines, "Added", [])
add_section(entry_lines, "Changed", changed_items)
add_section(entry_lines, "Fixed", [])
add_section(entry_lines, "Removed", [])
add_section(entry_lines, "Security", [])
add_section(entry_lines, "Upgrade Notes", [])
add_section(entry_lines, "Files", files)

entry = "\n".join(entry_lines) + "\n\n"
if os.path.exists(path):
    existing = open(path).read()
else:
    existing = ""
if existing.startswith(header):
    rest = existing[len(header):].lstrip("\n")
    new_content = header + "\n\n" + entry + rest
else:
    new_content = header + "\n\n" + entry + existing
open(path, 'w').write(new_content)
PY

git add "$VERSION_FILE" "$NOTES_FILE" "$CHANGELOG_FILE"

echo "BESEO pre-commit: bumped version to $new_version ($BUMP) and updated changelog."
