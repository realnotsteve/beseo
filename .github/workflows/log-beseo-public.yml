name: BE_SEO Commit Log

on:
  push:
    branches:
      - '**'
    paths:
      - 'BE_SEO-Dev_Notes.txt'
      - 'be-schema-engine/**'

jobs:
  log-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Ensure commit log file exists and is valid JSON
      run: |
        if [ ! -f BE_SEO-Commit_Log.json ]; then
          echo "Log file missing. Creating []"
          echo "[]" > BE_SEO-Commit_Log.json
        fi
        if ! jq -e 'if type=="array" then . else error("Not an array") end' BE_SEO-Commit_Log.json > /dev/null 2>&1; then
          echo "Log file is invalid. Resetting to []"
          echo "[]" > BE_SEO-Commit_Log.json
        fi

    - name: Build new log entry and append to log file
      env:
        GITHUB_REF: ${{ github.ref }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_MESSAGE: ${{ github.event.head_commit.message }}
        GITHUB_AUTHOR: ${{ github.event.head_commit.author.name }}
      run: |
        # 1. Get the list of changed files (Status + Filename)
        # git diff-tree returns lines like: "M    src/file.js"
        # We transform this into a JSON array: [{"status": "M", "file": "src/file.js"}, ...]
        
        FILES_JSON=$(git diff-tree --no-commit-id --name-status -r $GITHUB_SHA | \
          while read status file; do
            echo "{\"status\": \"$status\", \"file\": \"$file\"}"
          done | jq -s '.' || echo "[]")

        # 2. Build the main JSON object safely
        NEW_LOG=$(jq -n \
          --arg timestamp "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
          --arg branch "$GITHUB_REF" \
          --arg msg "$GITHUB_MESSAGE" \
          --arg author "$GITHUB_AUTHOR" \
          --argjson files "$FILES_JSON" \
          '{
             timestamp: $timestamp, 
             branch: $branch, 
             commit_message: $msg, 
             commit_author: $author,
             files_changed: $files
           }'
        )

        # 3. Append to file
        jq ". + [$NEW_LOG]" BE_SEO-Commit_Log.json > BE_SEO-Commit_Log.tmp \
          && mv BE_SEO-Commit_Log.tmp BE_SEO-Commit_Log.json

    - name: Commit and push updated log
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        git add -f BE_SEO-Commit_Log.json

        if git diff --staged --quiet; then
          echo "No changes to commit."
        else
          git commit -m "Update BE_SEO commit log [skip ci]"
          git push origin HEAD:$GITHUB_REF
        fi
