name: Update Commit Log

on:
  push:
    branches:
      - '**'  # Trigger on pushes to any branch
    paths-ignore:
      - 'BE_SEO-Commit_Log.json'  # Exclude the log file from triggering the workflow

jobs:
  log-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v3

    - name: Ensure Commit Log File Exists and Is Valid
      run: |
        if [ ! -f BE_SEO-Commit_Log.json ] || ! jq empty BE_SEO-Commit_Log.json > /dev/null 2>&1; then
          echo "Log file is missing or invalid. Initializing as an empty JSON array."
          echo "[]" > BE_SEO-Commit_Log.json
        fi

    - name: Generate a New JSON Entry for the Push
      env:
        GITHUB_REF: ${{ github.ref }}
        GITHUB_MESSAGE: ${{ github.event.head_commit.message }}
        GITHUB_AUTHOR: ${{ github.event.head_commit.committer.name }}
      run: |
        NEW_LOG=$(cat <<EOF
        {
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "branch": "${GITHUB_REF}",
          "commit_message": "${GITHUB_MESSAGE}",
          "commit_author": "${GITHUB_AUTHOR}"
        }
        EOF
        )
        echo "Generated NEW_LOG:"
        echo "$NEW_LOG" | jq . || (echo "Invalid JSON entry. Exiting workflow." && exit 1)

        jq ". + [$NEW_LOG]" BE_SEO-Commit_Log.json > tmp-log.json && mv tmp-log.json BE_SEO-Commit_Log.json

        echo "Log file contents after update:"
        cat BE_SEO-Commit_Log.json

    - name: Commit and Push Updated Commit Log
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add BE_SEO-Commit_Log.json
        git commit -m "Update Commit Log"
        git push origin HEAD
