name: Update Commit Log

on:
  push:
    branches:
      - '**' # Listen for pushes to all branches

jobs:
  log-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v3

    - name: Ensure Commit Log File Exists
      run: |
        if [ ! -f BE_SEO-Commit_Log.json ]; then
          echo "[]" > BE_SEO-Commit_Log.json
        fi

    - name: Generate a new JSON entry for the push
      env:
        GITHUB_REF: ${{ github.ref }}
        GITHUB_MESSAGE: ${{ github.event.head_commit.message }}
        GITHUB_AUTHOR: ${{ github.event.head_commit.committer.name }}
      run: |
        # Check for file changes using git diff
        if git rev-parse HEAD^ >/dev/null 2>&1; then
          FILE_DIFF=$(git diff HEAD^ HEAD --name-status | jq -R 'split("\t") | {file: .[1], status: .[0]}')
        else
          FILE_DIFF="[]"
        fi

        # Create the JSON entry
        NEW_LOG=$(cat <<EOF
        {
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "branch": "${GITHUB_REF}",
          "commit_message": "${GITHUB_MESSAGE}",
          "commit_author": "${GITHUB_AUTHOR}",
          "files_changed": $FILE_DIFF
        }
        EOF
        )
        echo "$NEW_LOG" | jq . || (echo "Invalid JSON entry, stopping workflow" && exit 1)

        # Append the JSON entry to the log
        jq ". + [$NEW_LOG]" BE_SEO-Commit_Log.json > tmp-log.json && mv tmp-log.json BE_SEO-Commit_Log.json

    - name: Check for Changes in Log File
      id: check_changes
      run: |
        if git diff --quiet BE_SEO-Commit_Log.json; then
          echo "No changes detected. Exiting successfully."
          exit 0  # Graceful exit if no changes
        else
          echo "::set-output name=changes_detected::true"
        fi

    - name: Debug Log File and Git Status
      if: always() # Always run this step for debugging
      run: |
        echo "Contents of BE_SEO-Commit_Log.json:"
        cat BE_SEO-Commit_Log.json
        echo "Unstaged changes:"
        git status

    - name: Commit and Push Updated Commit Log
      if: steps.check_changes.outputs.changes_detected == 'true' # Run only if changes are detected
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add BE_SEO-Commit_Log.json
        git commit -m "Update Commit Log"
        git push origin HEAD
