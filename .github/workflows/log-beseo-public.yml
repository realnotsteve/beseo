name: BE_SEO Commit Log

on:
  push:
    branches:
      - '**'
    # Only run this workflow when these paths change:
    paths:
      - 'BE_SEO-Dev_Notes.txt'
      - 'be-schema-engine/**'
    # And do NOT trigger when only the log file itself changes
    paths-ignore:
      - 'BE_SEO-Commit_Log.json'

jobs:
  log-commit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # Full history so HEAD^ and diffs are reliable if you ever add them
        fetch-depth: 0

    - name: Ensure commit log file exists and is valid JSON
      run: |
        if [ ! -f BE_SEO-Commit_Log.json ]; then
          echo "Log file missing. Initializing as empty JSON array."
          echo "[]" > BE_SEO-Commit_Log.json
        else
          # If the file is blank or invalid JSON, reset it to []
          if ! jq empty BE_SEO-Commit_Log.json > /dev/null 2>&1; then
            echo "Log file invalid JSON. Re-initializing as empty JSON array."
            echo "[]" > BE_SEO-Commit_Log.json
          fi
        fi

        echo "=== Log file AFTER initialization ==="
        cat BE_SEO-Commit_Log.json || echo "(could not read log file)"

    - name: Build new log entry and append to log file
      env:
        GITHUB_REF: ${{ github.ref }}
        GITHUB_MESSAGE: ${{ github.event.head_commit.message }}
        GITHUB_AUTHOR: ${{ github.event.head_commit.author.name }}
      run: |
        # Build NEW_LOG as a JSON object. ${var@Q} safely quotes strings for JSON.
        NEW_LOG=$(cat <<EOF
        {
          "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "branch": "${GITHUB_REF}",
          "commit_message": ${GITHUB_MESSAGE@Q},
          "commit_author": ${GITHUB_AUTHOR@Q}
        }
        EOF
        )

        echo "=== NEW_LOG (raw) ==="
        echo "$NEW_LOG"

        echo "=== NEW_LOG (jq-validated) ==="
        echo "$NEW_LOG" | jq . || (echo "NEW_LOG is invalid JSON, aborting." && exit 1)

        # Append NEW_LOG to the existing JSON array in BE_SEO-Commit_Log.json
        jq ". + [$NEW_LOG]" BE_SEO-Commit_Log.json > BE_SEO-Commit_Log.tmp \
          && mv BE_SEO-Commit_Log.tmp BE_SEO-Commit_Log.json

        echo "=== Log file AFTER append ==="
        cat BE_SEO-Commit_Log.json

    - name: Commit and push updated log (if there are changes)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        echo "=== git status BEFORE add ==="
        git status

        git add BE_SEO-Commit_Log.json

        echo "=== git status AFTER add ==="
        git status

        # Try to commit; if there's nothing to commit, don't fail the job
        if git commit -m "Update BE_SEO commit log"; then
          echo "Commit created, pushing..."
          git push origin HEAD
        else
          echo "No changes to commit (working tree clean). Nothing to push."
        fi
